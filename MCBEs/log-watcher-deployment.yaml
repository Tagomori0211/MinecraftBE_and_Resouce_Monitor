apiVersion: v1
kind: ConfigMap
metadata:
  name: log-watcher-script
  namespace: default
data:
  main.py: |
    import time
    import re
    import sys
    from kubernetes import client, config
    from kubernetes.client.rest import ApiException
    from prometheus_client import start_http_server, Gauge

    # --- Prometheus Metrics ---
    PLAYER_ONLINE_STATUS = Gauge(
        'minecraft_player_online_status',
        'Current online status of the player (1 for online, 0 for offline)',
        ['user_name']
    )

    # --- Helper: Remove ANSI Color Codes ---
    def strip_ansi_codes(text):
        ansi_escape = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
        return ansi_escape.sub('', text)

    # --- Log Parsing Logic ---
    def parse_log_line(line):
        clean_line = strip_ansi_codes(line)
        # Log format example:
        # [2025-12-04 ... INFO] Player connected: Shinari5295, xuid: ...
        login_pattern = r"Player connected:\s*(.+?),\s*xuid"
        logout_pattern = r"Player disconnected:\s*(.+?),\s*xuid"
        
        match_login = re.search(login_pattern, clean_line)
        if match_login: 
            return 'LOGIN', match_login.group(1).strip()
        
        match_logout = re.search(logout_pattern, clean_line)
        if match_logout: 
            return 'LOGOUT', match_logout.group(1).strip()
        
        return None, None

    # --- K8s Logic ---
    def get_minecraft_pod(v1, namespace, label_selector):
        try:
            pods = v1.list_namespaced_pod(namespace, label_selector=label_selector)
            for pod in pods.items:
                if pod.status.phase == "Running": return pod.metadata.name
        except ApiException as e:
            print(f"Error listing pods: {e}")
        return None

    def watch_logs():
        try:
            config.load_incluster_config()
        except Exception:
            print("Failed to load in-cluster config")
            sys.exit(1)

        v1 = client.CoreV1Api()
        NAMESPACE = "default"
        POD_LABEL_SELECTOR = "app=minecraft-bedrock"

        print("ğŸš€ Minecraft Log Exporter started (Direct Stream Mode)")

        while True:
            pod_name = get_minecraft_pod(v1, NAMESPACE, POD_LABEL_SELECTOR)
            if not pod_name:
                print("â³ Pod not found. Retrying in 10s...")
                time.sleep(10)
                continue

            print(f"TARGET POD: {pod_name}. Connecting to stream...")
            
            try:
                # ã€ä¿®æ­£ã€‘watchã‚’ä½¿ã‚ãšã€responseã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥åå¾©å‡¦ç†ã™ã‚‹
                # _preload_content=False ã«ã™ã‚‹ã“ã¨ã§ã€è¡Œã”ã¨ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã‚’å–å¾—
                resp = v1.read_namespaced_pod_log(
                    name=pod_name,
                    namespace=NAMESPACE,
                    container="minecraft",
                    follow=True,
                    _preload_content=False
                )
                
                # ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‹ã‚‰1è¡Œãšã¤èª­ã¿å‡ºã—
                for line_bytes in resp:
                    if not line_bytes: continue
                    
                    # bytes -> string
                    line = line_bytes.decode('utf-8').strip()
                    
                    # Debugå‡ºåŠ› (ç¢ºèªå¾Œã€ã†ã‚‹ã•ã‘ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆå¯)
                    print(f"[RAW] {line}")

                    event, user = parse_log_line(line)
                    if event == 'LOGIN':
                        print(f"âœ… LOGIN: {user}")
                        PLAYER_ONLINE_STATUS.labels(user_name=user).set(1)
                    elif event == 'LOGOUT':
                        print(f"ğŸšª LOGOUT: {user}")
                        PLAYER_ONLINE_STATUS.labels(user_name=user).set(0)

            except Exception as e:
                print(f"âš ï¸ Stream connection lost: {e}")
                time.sleep(5)

    if __name__ == '__main__':
        start_http_server(8000)
        watch_logs()

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-watcher
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: log-watcher
  template:
    metadata:
      labels:
        app: log-watcher
    spec:
      serviceAccountName: log-watcher-sa
      containers:
        - name: log-watcher
          image: python:3.9-slim
          # ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
          command: ["/bin/sh", "-c"]
          args: ["pip install --no-cache-dir kubernetes prometheus-client && python -u /app/main.py"]
          ports:
            - containerPort: 8000
          env:
            - name: TZ
              value: "Asia/Tokyo"
          volumeMounts:
            - name: script-volume
              mountPath: /app
      volumes:
        - name: script-volume
          configMap:
            name: log-watcher-script

---
apiVersion: v1
kind: Service
metadata:
  name: log-watcher-svc
  namespace: default
spec:
  type: NodePort
  selector:
    app: log-watcher
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
      nodePort: 30003
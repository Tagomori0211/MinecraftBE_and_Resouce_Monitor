apiVersion: v1
kind: ConfigMap
metadata:
  name: log-watcher-script
  namespace: default
data:
  main.py: |
    import time
    import re
    import sys
    from kubernetes import client, config, watch
    from kubernetes.client.rest import ApiException
    from prometheus_client import start_http_server, Gauge

    # --- Prometheus Metrics ---
    PLAYER_ONLINE_STATUS = Gauge(
        'minecraft_player_online_status',
        'Current online status of the player (1 for online, 0 for offline)',
        ['user_name']
    )

    # --- Helper: Remove ANSI Color Codes ---
    def strip_ansi_codes(text):
        ansi_escape = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
        return ansi_escape.sub('', text)

    # --- Log Parsing Logic (Robust Version) ---
    def parse_log_line(line):
        # 1. è‰²ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»ã—ã¦ãã‚Œã„ãªãƒ†ã‚­ã‚¹ãƒˆã«ã™ã‚‹
        clean_line = strip_ansi_codes(line)
        
        # 2. åˆ¤å®š (ç©ºç™½ã®ã‚†ã‚‰ãã‚’è¨±å®¹ã™ã‚‹ \s* ã‚’ä½¿ç”¨)
        # Target: "Player connected: Shinari5295, xuid:..."
        login_pattern = r"Player connected:\s*(.+?),\s*xuid"
        logout_pattern = r"Player disconnected:\s*(.+?),\s*xuid"
        
        match_login = re.search(login_pattern, clean_line)
        if match_login: 
            return 'LOGIN', match_login.group(1).strip()
        
        match_logout = re.search(logout_pattern, clean_line)
        if match_logout: 
            return 'LOGOUT', match_logout.group(1).strip()
        
        return None, None

    # --- K8s Logic ---
    def get_minecraft_pod(v1, namespace, label_selector):
        try:
            pods = v1.list_namespaced_pod(namespace, label_selector=label_selector)
            for pod in pods.items:
                if pod.status.phase == "Running": return pod.metadata.name
        except ApiException as e:
            print(f"Error listing pods: {e}")
        return None

    def watch_logs():
        try:
            config.load_incluster_config()
        except Exception:
            print("Failed to load in-cluster config")
            sys.exit(1)

        v1 = client.CoreV1Api()
        w = watch.Watch()
        NAMESPACE = "default"
        POD_LABEL_SELECTOR = "app=minecraft-bedrock"

        print("ğŸš€ Minecraft Log Exporter started (DEBUG MODE)")

        while True:
            pod_name = get_minecraft_pod(v1, NAMESPACE, POD_LABEL_SELECTOR)
            if not pod_name:
                print("â³ Pod not found. Retrying in 10s...")
                time.sleep(10)
                continue

            print(f"TARGET POD: {pod_name}. Streaming logs...")
            try:
                # ã‚³ãƒ³ãƒ†ãƒŠåã‚’æŒ‡å®šã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
                for line in w.stream(v1.read_namespaced_pod_log, name=pod_name, namespace=NAMESPACE, container="minecraft", follow=True):
                    # ã€ãƒ‡ãƒãƒƒã‚°ç”¨ã€‘å—ã‘å–ã£ãŸç”Ÿãƒ­ã‚°ã‚’å¼·åˆ¶å‡ºåŠ›ï¼ˆã“ã‚Œã§ä½•ã‚‚å‡ºãªã‘ã‚Œã°K8så´ã®å•é¡Œï¼‰
                    print(f"[RAW] {line.strip()}")
                    
                    event, user = parse_log_line(line.strip())
                    
                    if event == 'LOGIN':
                        print(f"âœ… LOGIN DETECTED: {user}")
                        PLAYER_ONLINE_STATUS.labels(user_name=user).set(1)
                    elif event == 'LOGOUT':
                        print(f"ğŸšª LOGOUT DETECTED: {user}")
                        PLAYER_ONLINE_STATUS.labels(user_name=user).set(0)
                        
            except Exception as e:
                print(f"âš ï¸ Stream Error: {e}. Reconnecting...")
                time.sleep(5)

    if __name__ == '__main__':
        start_http_server(8000)
        watch_logs()

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-watcher
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: log-watcher
  template:
    metadata:
      labels:
        app: log-watcher
    spec:
      serviceAccountName: log-watcher-sa
      containers:
        - name: log-watcher
          image: python:3.9-slim
          # æ¨™æº–å‡ºåŠ›ã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã‚’ç„¡åŠ¹åŒ– (-u)
          command: ["/bin/sh", "-c"]
          args: ["pip install --no-cache-dir kubernetes prometheus-client && python -u /app/main.py"]
          ports:
            - containerPort: 8000
          env:
            - name: TZ
              value: "Asia/Tokyo"
          volumeMounts:
            - name: script-volume
              mountPath: /app
      volumes:
        - name: script-volume
          configMap:
            name: log-watcher-script

---
apiVersion: v1
kind: Service
metadata:
  name: log-watcher-svc
  namespace: default
spec:
  type: NodePort
  selector:
    app: log-watcher
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
      nodePort: 30003
name: Deploy Minecraft Dashboard (Hybrid On-Premise)

on:
  push:
    branches:
      - main
  repository_dispatch:
    types: [new-minecraft-backup]

jobs:
  deploy_on_premise:
    # 自宅サーバーのランナーを指定
    runs-on: [self-hosted, Linux] 
    steps:
    # 1. コードの取得
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 環境変数のセットアップ
    # 【重要】GitHubの Settings > Secrets にこれらを登録しておくこと！
    - name: Create .env file
      run: |
        echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
        echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
        echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
        # Flask用の秘密鍵も追加しておくとGood
        echo "FLASK_APP_SECRET_KEY=${{ secrets.FLASK_APP_SECRET_KEY }}" >> .env

    # 3. Docker Compose でビルド & 起動
    - name: Build and Deploy locally
      run: |
        # コマンドは「ハイフンなし」に統一！
        docker compose up -d --build --remove-orphans
        
        # 不要なイメージ削除
        docker image prune -f

    # 4. データ取り込み処理 (一旦無効化！)
    # main.pyが無限ループする状態なので、実行するとパイプラインが止まってしまいます。
    # 解析ロジックが完成するまでコメントアウトしておきます。
    # - name: Trigger data ingestion
    #   if: github.event_name == 'repository_dispatch' && github.event.action == 'new-minecraft-backup'
    #   run: |
    #     # ハイフンなしに修正 & スクリプト名を修正
    #     docker compose run --rm parser python /app/main.py